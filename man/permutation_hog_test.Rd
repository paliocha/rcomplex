% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/summary.R
\name{permutation_hog_test}
\alias{permutation_hog_test}
\title{Permutation-based HOG-level conservation/divergence test}
\usage{
permutation_hog_test(
  net1,
  net2,
  comparison,
  alternative = c("greater", "less"),
  min_exceedances = 50L,
  max_permutations = 10000L,
  n_cores = 1L,
  fdr_method = "fdr"
)
}
\arguments{
\item{net1}{Network object for species 1 (output of \code{\link[=compute_network]{compute_network()}}).}

\item{net2}{Network object for species 2 (output of \code{\link[=compute_network]{compute_network()}}).}

\item{comparison}{Data frame from \code{\link[=compare_neighborhoods]{compare_neighborhoods()}} --- raw p-values,
\strong{not} FDR-corrected. Used to define HOG structure and extract effect sizes.}

\item{alternative}{Which tail to test: \code{"greater"} (default) for conservation
or \code{"less"} for divergence.}

\item{min_exceedances}{Besag & Clifford stopping parameter: stop permuting
once this many permutation statistics exceed (or fall below) T_obs.
Higher values give more precise p-values but take longer (default 50).}

\item{max_permutations}{Maximum permutations per HOG (default 10000).}

\item{n_cores}{Number of threads for parallel computation (default 1).}

\item{fdr_method}{P-value adjustment method passed to \code{\link[=p.adjust]{p.adjust()}}
(default \code{"fdr"}).}
}
\value{
A data frame with one row per HOG, ordered by p-value, with columns:
\describe{
\item{OrthoGroup}{HOG identifier}
\item{n_pairs}{Number of ortholog pairs (M x N) in this HOG}
\item{n_sp1}{Number of unique species-1 genes (M)}
\item{n_sp2}{Number of unique species-2 genes (N)}
\item{T_obs}{Observed sum-of-fold-enrichments statistic}
\item{n_perm}{Number of permutations performed (may be < max_permutations
due to adaptive stopping)}
\item{n_exceed}{Number of permutation statistics exceeding T_obs}
\item{mean_eff}{Mean geometric-mean effect size across pairs}
\item{p.value}{Permutation p-value: (n_exceed + 1) / (n_perm + 1)}
\item{q.value}{FDR-adjusted p-value}
}
}
\description{
Tests each Hierarchical Ortholog Group (HOG) for co-expression conservation
(or divergence) using a gene-identity permutation null with adaptive stopping
(Besag & Clifford, 1991).
}
\section{Statistical method}{

The null hypothesis is that the specific gene identities in a HOG carry no
information about co-expression conservation: replacing the HOG's genes with
randomly chosen genes from the same networks would yield equally large
neighborhood overlap.

For each permutation, M random species-1 genes and N random species-2 genes
are drawn (matching the HOG's gene counts), and the sum-of-fold-enrichments
statistic T is computed over all M x N pair x direction combinations. The
permutation p-value is the fraction of permuted T values that exceed (or
fall below, for divergence) the observed T.

The Besag & Clifford (1991) sequential stopping rule terminates permutations
early once \code{min_exceedances} permutation statistics exceed T_obs,
providing efficient computation without sacrificing accuracy for clearly
significant or non-significant HOGs.
}

\section{Why not Fisher's method}{

Fisher's method for combining p-values assumes independent tests. Within a
HOG, pair-level hypergeometric tests share network neighborhoods (genes
co-expressed with one HOG member are often co-expressed with another) and
share the ortholog mapping. This non-independence inflates Fisher's statistic
and produces anti-conservative p-values. The permutation approach is exact
regardless of the dependency structure.
}

\section{Intersection modes}{

For networks with max(n1, n2) <= 100,000 genes, bit-vector intersection
with popcount is used for maximum throughput. For larger networks, a
flag-vector approach (sparse set/count/clear) avoids excessive memory use.
}

\references{
Besag, J. & Clifford, P. (1991). Sequential Monte Carlo p-values.
\emph{Biometrika}, 78(2), 301--304. \doi{10.1093/biomet/78.2.301}
}

<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comparative Co-Expression Network Analysis Across Species • rcomplex</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Comparative Co-Expression Network Analysis Across Species">
<meta property="og:description" content="Compares gene co-expression networks across plant species by mapping orthologous genes (via PLAZA ortholog groups), building co-expression networks independently per species, then testing whether network neighborhoods are significantly preserved using hypergeometric tests with FDR correction and effect sizes. Based on Netotea et al. (2014) &lt;doi:10.1186/1471-2164-15-106&gt;.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">rcomplex</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/paliocha/rcomplex/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="contents col-md-9">
<div class="section level1">
<div class="page-header"><h1 id="rcomplex">rcomplex<a class="anchor" aria-label="anchor" href="#rcomplex"></a>
</h1></div>
<p>Comparative co-expression network analysis across species.</p>
<p>Compares gene co-expression networks across plant species by mapping orthologous genes (via PLAZA ortholog groups), building co-expression networks independently per species, then testing whether network neighborhoods are significantly preserved using hypergeometric tests with FDR correction and effect sizes.</p>
<p>Based on <a href="https://doi.org/10.1186/1471-2164-15-106" class="external-link">Netotea <em>et al.</em>, 2014</a>.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install from GitHub</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"paliocha/rcomplex"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="workflow">Workflow<a class="anchor" aria-label="anchor" href="#workflow"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://paliocha.github.io/rcomplex/" class="external-link">rcomplex</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Parse ortholog groups</span></span>
<span><span class="va">orthologs</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/parse_orthologs.html">parse_orthologs</a></span><span class="op">(</span><span class="st">"orthogroups.txt"</span>, <span class="st">"Species1"</span>, <span class="st">"Species2"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Build co-expression networks</span></span>
<span><span class="va">net1</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/compute_network.html">compute_network</a></span><span class="op">(</span><span class="va">expr1</span>, norm_method <span class="op">=</span> <span class="st">"MR"</span>, density <span class="op">=</span> <span class="fl">0.03</span><span class="op">)</span></span>
<span><span class="va">net2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/compute_network.html">compute_network</a></span><span class="op">(</span><span class="va">expr2</span>, norm_method <span class="op">=</span> <span class="st">"MR"</span>, density <span class="op">=</span> <span class="fl">0.03</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Compare neighborhoods (pair-level hypergeometric tests)</span></span>
<span><span class="va">comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/compare_neighborhoods.html">compare_neighborhoods</a></span><span class="op">(</span><span class="va">net1</span>, <span class="va">net2</span>, <span class="va">orthologs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4a. Pair-level summary with FDR</span></span>
<span><span class="va">summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/summarize_comparison.html">summarize_comparison</a></span><span class="op">(</span><span class="va">comparison</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4b. HOG-level permutation test (recommended for multi-copy gene families)</span></span>
<span><span class="va">hog_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/permutation_hog_test.html">permutation_hog_test</a></span><span class="op">(</span><span class="va">net1</span>, <span class="va">net2</span>, <span class="va">comparison</span>, n_cores <span class="op">=</span> <span class="fl">4L</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="hog-level-permutation-test">HOG-level permutation test<a class="anchor" aria-label="anchor" href="#hog-level-permutation-test"></a>
</h2>
<div class="section level3">
<h3 id="the-problem-with-fishers-method">The problem with Fisher’s method<a class="anchor" aria-label="anchor" href="#the-problem-with-fishers-method"></a>
</h3>
<p>A naive approach to HOG-level testing would combine pair-level p-values using Fisher’s method. However, Fisher’s method assumes independent tests. Within a HOG, pair-level hypergeometric tests are correlated because:</p>
<ul>
<li>
<strong>Shared neighborhoods</strong>: Genes in the same HOG often share co-expression neighbors (especially after whole-genome duplication), so their neighborhood overlap tests draw from overlapping gene sets.</li>
<li>
<strong>Shared ortholog mapping</strong>: The same ortholog table mediates the neighborhood comparison for all pairs in a HOG. Two pairs sharing an sp2 gene use identical ortholog-mapped neighbor sets for one direction.</li>
</ul>
<p>This non-independence inflates Fisher’s statistic and produces anti-conservative (overly optimistic) p-values. The severity depends on HOG size: 1:1 HOGs have no issue, but multi-copy HOGs (e.g., 5x5 = 25 pairs) can be strongly affected.</p>
</div>
<div class="section level3">
<h3 id="the-permutation-approach">The permutation approach<a class="anchor" aria-label="anchor" href="#the-permutation-approach"></a>
</h3>
<p><code><a href="reference/permutation_hog_test.html">permutation_hog_test()</a></code> replaces Fisher’s method with an exact permutation test that is valid regardless of the dependency structure.</p>
<p><strong>Null hypothesis (gene-identity permutation)</strong>: The specific gene identities in a HOG carry no information about co-expression conservation. Replacing the HOG’s M species-1 genes and N species-2 genes with randomly chosen genes from the same networks would yield equally large neighborhood overlap.</p>
<p><strong>Test statistic</strong>: Sum of fold-enrichments across all M x N pair x direction combinations:</p>
<pre><code>T = sum_{i,j} [ x1_ij / E1_ij + x2_ij / E2_ij ]</code></pre>
<p>where <code>x</code> is the observed overlap and <code>E = m * k / N_total</code> is the hypergeometric expectation. This avoids expensive <code><a href="https://rdrr.io/r/stats/Hypergeometric.html" class="external-link">phyper()</a></code> calls during permutations while remaining monotonically related to the conservation signal.</p>
<p><strong>Precomputed reachable sets</strong>: For each gene in each network, the set of cross-species genes reachable through network neighbors and the ortholog mapping is precomputed once. This reduces each permutation to set intersections rather than full neighborhood recomputations.</p>
<p><strong>Intersection modes</strong>: - <strong>Bit-vector</strong> (when max(n1, n2) &lt;= 100,000): Each neighbor/reachable set is stored as a bit-vector. Intersection is computed via bitwise AND + popcount, achieving ~0.15 us per intersection on modern CPUs. - <strong>Flag-vector</strong> (when max(n1, n2) &gt; 100,000): Sparse set representation with a flag array for intersection counting. Avoids the O(n^2/8) memory cost of bit-vectors for very large networks.</p>
</div>
<div class="section level3">
<h3 id="adaptive-stopping-besag--clifford-1991">Adaptive stopping (Besag &amp; Clifford, 1991)<a class="anchor" aria-label="anchor" href="#adaptive-stopping-besag--clifford-1991"></a>
</h3>
<p>Rather than running a fixed number of permutations for every HOG, the implementation uses the sequential Monte Carlo stopping rule of Besag &amp; Clifford (1991). Permutations continue until <code>min_exceedances</code> (default: 50) permutation statistics exceed (or fall below, for divergence) the observed statistic, then:</p>
<pre><code><span><span class="va">p</span> <span class="op">=</span> <span class="op">(</span><span class="va">n_exceed</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">n_perm</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span></code></pre>
<p>This provides: - <strong>Efficiency</strong>: Clearly non-significant HOGs stop after ~50 permutations (exceedances accumulate immediately). Clearly significant HOGs also stop relatively quickly. Only borderline HOGs use the full permutation budget. - <strong>Precision where it matters</strong>: The p-value estimate has relative precision ~1/sqrt(min_exceedances), so with 50 exceedances the coefficient of variation is ~14%, sufficient for FDR correction.</p>
</div>
<div class="section level3">
<h3 id="why-permutation-over-fishers-method">Why permutation over Fisher’s method?<a class="anchor" aria-label="anchor" href="#why-permutation-over-fishers-method"></a>
</h3>
<p>Fisher’s method combines pair-level p-values by assuming independence: <code>X² = -2 Σ log(p_i)</code>. Within a HOG, however, pairs share co-expression neighbors and ortholog mappings, so the p-values are positively correlated. This inflates Fisher’s statistic and produces false positives — the severity scales with HOG size (a 5x5 HOG has 25 correlated tests).</p>
<p>The permutation approach sidesteps this entirely. By permuting gene identities and recomputing the test statistic from scratch, the correlation structure between pairs is present in both the observed and null distributions. No independence assumption is needed; the test is exact by construction.</p>
<p><code><a href="reference/permutation_hog_test.html">permutation_hog_test()</a></code> avoids the independence assumption entirely, making it valid for all HOG sizes.</p>
</div>
<div class="section level3">
<h3 id="performance-column-major-memory-access">Performance: column-major memory access<a class="anchor" aria-label="anchor" href="#performance-column-major-memory-access"></a>
</h3>
<p>The C++ backend (Armadillo, column-major storage) is optimized for sequential memory access. Since correlation and network matrices are symmetric, column access (<code>sim.col(i)</code>, <code>net.colptr(i)</code>) returns the same values as row access but with sequential rather than strided reads. This applies to:</p>
<ul>
<li>
<strong>MR normalization</strong> (<code>mutual_rank_transform_cached_cpp</code>): ranks are computed from <code>sim.col(i)</code> and stored by column, avoiding O(n) cache misses per gene.</li>
<li>
<strong>Neighbor list extraction</strong> (<code>hog_permutation_test_cpp</code>): <code>net.colptr(i)</code> gives a sequential scan of gene i’s co-expression values.</li>
</ul>
<p>On a 22K-gene network pair, this gives a ~3x speedup over naive row access (380s to 126s per species comparison with 8 OpenMP threads).</p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li>Netotea, S. <em>et al.</em> (2014). ComPlEx: conservation and divergence of co-expression networks in <em>A. thaliana</em>, <em>Populus</em> and <em>O. sativa</em>. <em>BMC Genomics</em>, 15, 106. <a href="https://doi.org/10.1186/1471-2164-15-106" class="external-link">doi:10.1186/1471-2164-15-106</a>
</li>
<li>Besag, J. &amp; Clifford, P. (1991). Sequential Monte Carlo p-values. <em>Biometrika</em>, 78(2), 301–304. <a href="https://doi.org/10.1093/biomet/78.2.301" class="external-link">doi:10.1093/biomet/78.2.301</a>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="license">License<a class="anchor" aria-label="anchor" href="#license"></a>
</h2>
<p>MIT</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/paliocha/rcomplex/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/paliocha/rcomplex/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li>
<a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a>
</li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing rcomplex</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Martin Paliocha <br><small class="roles"> Author, maintainer </small>   </li>
</ul>
</div>



  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Martin Paliocha.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
